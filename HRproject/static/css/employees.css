document.addEventListener("DOMContentLoaded", () => {

    const rankBtn = document.getElementById("rankButton");

    if (rankBtn) {
        rankBtn.addEventListener("click", async (event) => {
            event.preventDefault();
            event.stopPropagation();

            // --- If button is switching to UNRANK ---
            if (rankBtn.innerText === "Unrank") {
                rankBtn.disabled = true;
                rankBtn.innerText = "Clearing...";

                await fetch("/clear_ai_scores", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });

                // Reset UI visually
                document.querySelectorAll(".score-cell").forEach(cell => {
                    cell.innerText = "-";
                });

                rankBtn.disabled = false;
                rankBtn.innerText = "Rank";
                return;
            }

            // --- Otherwise run RANKING ---
            rankBtn.disabled = true;
            rankBtn.innerText = "Ranking...";

            try {
                const response = await fetch("/rank_all_candidates", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });

                const data = await response.json();

                // Apply scores to UI
                data.forEach(result => {
                    const row = document.querySelector(`tr[data-id="${result.id}"]`);
                    if (row) {
                        const cell = row.querySelector(".score-cell");
                        if (cell) cell.innerText = result.score ?? "-";
                    }
                });

                // Sort table by score (descending)
                sortTableByScore();

                // Switch button to UNRANK
                rankBtn.innerText = "Unrank";

            } catch (err) {
                console.error("Ranking request failed:", err);
            }

            rankBtn.disabled = false;
        });
    }

    function sortTableByScore() {
        const table = document.getElementById("employeeTable");
        const rows = [...table.querySelectorAll("tbody tr")];

        rows.sort((a, b) => {
            const scoreA = parseInt(a.querySelector(".score-cell").innerText) || 0;
            const scoreB = parseInt(b.querySelector(".score-cell").innerText) || 0;
            return scoreB - scoreA;
        });

        const tbody = table.querySelector("tbody");
        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
    }

});
